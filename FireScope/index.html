<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .ctl {
      padding: 2px 10px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
      font-family: "Calibri", "Trebuchet MS", "Ubuntu", Serif;
      font-size: 11pt;
    }
    .title { font-size: 18pt; font-weight: bold; text-align: right; }
    .src { font-size: 10pt; }
    .timestamp {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.8);
      padding: 6px 12px;
      font-size: 14pt;
      font-family: sans-serif;
      z-index: 1000;
      border-radius: 4px;
    }
    .controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="controls">
  <button id="playPauseBtn">⏸ Pause</button>
  <input type="range" id="timeSlider" min="0" max="9" value="0" style="width:300px;" />
</div>

<script>
  // Base layers
  const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors', minZoom: 5, maxZoom: 15
  });
  const cartodb = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors, &copy; CartoDB', minZoom: 5, maxZoom: 15
  });
  const white = L.tileLayer("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEAAQMAAABmvDolAAAAA1BMVEX///+nxBvIAAAAH0lEQVQYGe3BAQ0AAADCIPunfg43YAAAAAAAAAAA5wIhAAAB9aK9BAAAAABJRU5ErkJggg==", {
    minZoom: 5, maxZoom: 15
  });

  const map = L.map('map', {
    center: [34.5, -118.5],
    zoom: 8,
    minZoom: 5,
    maxZoom: 15,
    layers: [osm]
  });

  const basemaps = {
    "OpenStreetMap": osm,
    "CartoDB Positron": cartodb,
    "Without background": white
  };
  L.control.layers(basemaps, {}, {collapsed: false}).addTo(map);

  // Title + 时间戳控件（右上角）
  const title = L.control({ position: 'topright' });
  title.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'ctl title');
    this.update("2025-10-01 14:00"); // 初始时间戳
    return this._div;
  };
  title.update = function(timeText) {
    this._div.innerHTML = `<div style="font-size:14pt; margin-top:4px;">${timeText}</div>`;
  };
  title.addTo(map);


  // Attribution
  const note = L.control({position: 'bottomleft'});
  note.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'ctl src');
    //this._div.innerHTML = 'Generated by Zhan';
    return this._div;
  };
  note.addTo(map);

  // Image overlay bounds
  const bounds = [[34.1, -119.4], [35.1, -118.4]];

  // Image sequence
  const imageLayers = [];
  const startTime = new Date("2025-10-11T00:00:00Z"); // 首图时间
  const intervalHours = 8;

  for (let i = 0; i < 10; i++) {
    const timestamp = new Date(startTime.getTime() + i * intervalHours * 60 * 60 * 1000);
    const index = ("0" + (i + 1)).slice(-2);
    const iso = timestamp.toISOString().replace("T", " ").slice(0, 16); // 格式化为 "YYYY-MM-DD HH:mm"
    imageLayers.push({
      //url: 'Layers/Fire/202510111400/batch_001_sample_000_timestep_' + index + '.png',
      url:'../assets/system_map_edited_LARGE.png',
      time: iso
    });
  }


  let currentIndex = 0;
  let currentOverlay = null;
  let playing = true;
  let intervalId = null;

  function showLayer(index) {
    if (currentOverlay) map.removeLayer(currentOverlay);
    const layer = imageLayers[index];
    currentOverlay = L.imageOverlay(layer.url, bounds, { opacity: 0.8 }).addTo(map);
    title.update(layer.time);
    document.getElementById('timeSlider').value = index;
  }

  function play() {
    intervalId = setInterval(() => {
      currentIndex = (currentIndex + 1) % imageLayers.length;
      showLayer(currentIndex);
    }, 1000);
  }

  function pause() {
    clearInterval(intervalId);
  }

  // 初始显示
  showLayer(currentIndex);
  play();

  // 播放/暂停按钮
  document.getElementById('playPauseBtn').onclick = () => {
    playing = !playing;
    if (playing) {
      document.getElementById('playPauseBtn').innerText = '⏸ Pause';
      play();
    } else {
      document.getElementById('playPauseBtn').innerText = '▶️ Play';
      pause();
    }
  };

  // 时间轴滑块
  document.getElementById('timeSlider').oninput = (e) => {
    currentIndex = parseInt(e.target.value);
    showLayer(currentIndex);
  };

  // 适配图像边界
  map.fitBounds(bounds);
</script>

</body>
</html>
